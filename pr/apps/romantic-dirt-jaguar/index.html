<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Test for a Payment Handler with an Origin Trial that removes identity in "canmakepayment" event</title>
<link rel="icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="../../style.css">
<script src="/pr/util.js"></script>
</head>
<body>
<div id="contents">
<h1>Test for the "canmakepayment" identity Origin Trialt</h1>
<p>Click <code>Run a test</code> to see a response from the payment handler.</p>
<ul>
<li>For the first run, the payment handler installs just-in-time, so its
<code>"canmakepayment"</code> event does not run. The payment handler response
will specify <code>"canMakePaymentRan": false</code>.
<li>For the consequent runs, the Chrome triggers the
<code>"canmakepayment"</code> event in the payment handler. The response will
respond with <code>"canMakePaymentRan": true</code>.
</ul>
<p>To see the origin trial token on the payment handler:</p>
<pre>
$ curl --head https://romantic-dirt-jaguar.glitch.me/sw.js | grep origin-trial
origin-trial: Auw/tjTQ2eJQ911wiMHi1Bb7i71hIV6v9pckwldaVyMfzpLfDhkkFI...
</pre>
<button onclick="runTest()">Run a test</button>
<pre id="msg"></pre>
</div>
<script>
let request = null;

function init() {
  request = new PaymentRequest([{supportedMethods:
    'https://romantic-dirt-jaguar.glitch.me/pay'}], {total: {label: 'Total',
    amount: {value: '0.01', currency: 'USD'}}});
  info('Initialized');
}

async function checkCanMakePayment() {
  try {
    info(await request.canMakePayment() ? 'Can make payment' : 'Cannot make payment');
  } catch (e) {
    error(e);
    init();
  }
}

async function runTest() {
  try {
    const response = await request.show();
    response.complete('success');
    info(JSON.stringify(response, undefined, 2));
    init();
  } catch (e) {
    error(e);
    init();
  }
}

init();
checkCanMakePayment();
</script>
</body>
</html>
