<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Secure Payment Confirmation</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" type="text/css" href="../style.css">
</head>

<body>
  <div id="contents">
    <h1>Secure Payment Confirmation</h1>
    <p>This is a test website. Nothing is charged.</p>
    <p><b style="color:red">Notice</b>:</p>
    <pre>
  Secure Payment Confirmation has been enabled by default since Chrome 95. Chrome 94 still needs an Origin Trial token to support SPC. The Origin Trial will end by the end of 2021.
    </pre>
    <p><button onclick="createPaymentCredential()">Enroll
        Credential</button></p>
    <p><button onclick="onBuyClicked()">Pay $0.01</button></p>
  </div>
  <pre id="msg"></pre>
  <p><em>Enroll Credential</em> will make the following request:
  <pre style="color: #265289">
async function createCredentialCompat() {
  const rp = {
    id: window.location.hostname,
    name: 'Rouslan Solomakhin',
  };
  const pubKeyCredParams = [{
    type: 'public-key',
    alg: -7, // ECDSA, not supported on Windows.
  }, {
    type: 'public-key',
    alg: -257, // RSA, supported on Windows.
  }];
  const challenge = textEncoder.encode('Enrollment challenge');
  if (window.PaymentCredential) {
    const payment = {
      rp,
      instrument: {
        displayName: 'Troy ····',
        icon: 'https://rsolomakhin.github.io/pr/spc/troy.png',
      },
      challenge,
      pubKeyCredParams,
      authenticatorSelection: {
        userVerification: 'required',
      },
    };
    return await navigator.credentials.create({
      payment
    });
  } else {
    const publicKey = {
      rp,
      user: {
        name: 'Troy ···· 1234',
        displayName: '',
        id: Uint8Array.from(String(Math.random()*999999999), c => c.charCodeAt(0)),
      },
      challenge,
      pubKeyCredParams,
      authenticatorSelection: {
        userVerification: 'required',
        residentKey: 'required',
        authenticatorAttachment: 'platform',
      },
      extensions: {
        payment: {
          isPayment: true,
        },
      }
    };
    return await navigator.credentials.create({
      publicKey
    });
  }
}
const publicKeyCredential = createCredentialCompat();
window.localStorage.setItem(
    'credential_identifier',
    btoa(String.fromCharCode(...new Uint8Array(
        publicKeyCredential.rawId))));</pre>
  </p>
  <p><em>Pay $0.01</em> will make the following request:
  <pre style="color: #265289">new PaymentRequest([{
  supportedMethods: 'secure-payment-confirmation',
  data: {
    credentialIds: [Uint8Array.from(
        atob(window.localStorage.getItem('credential_identifier')),
        c => c.charCodeAt(0))],
    instrument: {
      displayName: 'My Troy Card',
      icon: 'https://example.com/no-icon.png',
      iconMustBeShown: false,
    },
    challenge: textEncoder.encode('network_data'),
    timeout: 60000,
    payeeOrigin: window.location.origin,
    payeeName: 'Example Merchant',
    rpId: window.location.hostname,
  },
}], {
  total: {
    label: 'Total',
    amount: {
      currency: 'USD',
      value: '0.01',
    },
  },
});</pre>
  </p>
  <p><em>Login</em> will make the following request:
  <pre style="color: #265289">const publicKey = {
  challenge: textEncoder.encode('Authentication challenge'),
  userVerification: 'required',
  allowCredentials: [{
    transports: ['internal'],
    type: 'public-key',
    id: Uint8Array.from(
      atob(window.localStorage.getItem('credential_identifier')),
      c => c.charCodeAt(0)),
  }],
};
navigator.credentials.get({publicKey});</pre>
  </p>
  <p>Based on the <a
      href="https://github.com/w3c/secure-payment-confirmation">Secure Payment
      Confirmation explainer</a>.</p>
  <script src="../util.js"></script>
  <script src="pr.js"></script>
  <script src="/redirect.js"></script>
  <script>
    checkCanMakePayment();
  </script>
</body>

</html>
