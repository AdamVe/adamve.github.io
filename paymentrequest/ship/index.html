<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Society in Support of Venerable Rouslan Solomakhin</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    body {
      overflow: hidden;
    }
    div {
      margin-top: 10px;
    }
    .error {
      animation-duration: 0.5s;
      animation-name: popup;
      color: red;
    }
    @keyframes popup {
      from {
        margin-top: 20px;
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
    }
    .error-hide {
      animation-duration: 0.5s;
      animation-name: popdown;
      color: red;
    }
    @keyframes popdown {
      to {
        margin-top: 20px;
        opacity: 0;
      }
    }
    .info {
      color: green;
    }
    .fork {
      position: absolute;
      top: 0;
      right: 0;
      border: 0;
   }
  </style>
</head>
<body>
  <div id="contents">
    <div><em>The Society in Support of Venerable Rouslan Solomakhin</em></div>
    <div>Donation: <strong id="currency"></strong><strong id="amount"></strong></div>
    <div>Free standard shipping in California.</div>
    <div>Can ship only in US.</div>
    <div><button onclick="onBuyClicked()">Donate</button></div>
  </div>
  <pre id="errors"></pre>
  <pre id="messages"></pre>
  <script>
    var currency = "USD";
    document.getElementById("currency").innerHTML = "$";
    var amount = "65.00";
    var discount = "-10.00";
    var total = "55.00";
    document.getElementById("amount").innerHTML = total;

    // Shipping and total for: CA, US, and global.
    var prices = {
      "CA": {
        "shipping": "0.00",
        "total": "55.00",
      },
      "US": {
        "shipping": "5.00",
        "total": "60.00",
      }
    };

    var timeoutID1, timeoutID2;
    function error(msg) {
      if (timeoutID1) {
        window.clearTimeout(timeoutID1);
      }
      if (timeoutID2) {
        window.clearTimeout(timeoutID2);
      }
      var element = document.getElementById("errors");
      element.innerHTML += "<br>" + msg;
      element.className = "error";
      timeoutID1 = window.setTimeout(function() {
        element.className = "error-hide";
        timeoutID2 = window.setTimeout(function() {
          element.innerHTML = "";
          element.className = "";
        }, 500);
      }, 10000);
    }

    function info(msg) {
      var element = document.getElementById("messages");
      element.innerHTML += "<br>" + msg;
      element.className = "info";
    }

    function toDictionary(addr) {
      var result = {};
      result.regionCode = addr.regionCode;
      result.administrativeArea = addr.administrativeArea;
      result.locality = addr.locality;
      result.dependentLocality = addr.dependentLocality;
      result.addressLine = addr.addressLine;
      result.postalCode = addr.postalCode;
      result.sortingCode = addr.sortingCode;
      result.languageCode = addr.languageCode;
      result.organization = addr.organization;
      result.recipient = addr.recipient;
      return result;
    }

    function done(message, shippingAddress, shippingOption, methodName,
        instrumentDetails) {
      var element = document.getElementById("contents");
      element.innerHTML = message;

      info(JSON.stringify(toDictionary(shippingAddress), undefined, 2) +
           "<br/>" + shippingOption + "<br/>" + methodName + "<br/>" +
           JSON.stringify(instrumentDetails, undefined, 2));
    }

    function onBuyClicked() {
      var supportedInstruments = [
        "https://android.com/pay",
        "visa",
        "mastercard",
        "amex",
        "discover",
        "maestro",
        "diners",
        "jcb",
        "unionpay",
        "bitcoin",
        "bobpay.xyz"
      ];

      var SHIPPING_ITEM = 2;
      var TOTAL_ITEM = 3;
      var details = {
        "items": [{
          "id": "original",
          "label": "Original donation amount",
          "amount": {"currencyCode": currency, "value": amount}
        }, {
          "id": "discount",
          "label": "Friends and family discount",
          "amount": {"currencyCode": currency, "value": discount}
        }, {
          "id": "shipping",
          "label": "Shipping",
          "amount": {"currencyCode": currency, "value": "0"}
        }, {
          "id": "total",
          "label": "Donation",
          "amount": {"currencyCode": currency, "value": total}
        }]
      };

      var options = {
        "requestShipping": true
      };

      var schemeData = {
        "https://android.com/pay": {
          "gateway": "stripe",
          "stripe:publishableKey": "pk_test_VKUbaXb3LHE7GdxyOBMNwXqa",
          "stripe:version": "2015-10-16 (latest)"
        },
        "bobpay.xyz": {
          "merchantIdentifier": "XXXX",
          "bobPaySpecificField": true
        },
        "bitcoin": {
          "address": "XXXX"
        }
      };

      if (!window.PaymentRequest) {
        error("PaymentRequest API is not supported.");
        return;
      }

      try {

        var request = new PaymentRequest(
            supportedInstruments, details, options, schemeData);

        request.addEventListener("shippingaddresschange", function(e) {
          info("ShippingAddressChange");
          e.updateWith(new Promise(function(resolve, reject) {
            info("event.updateWith()");
            if (request.shippingAddress.regionCode == "US") {
              if (request.shippingAddress.administrativeArea == "CA") {
                details.items[SHIPPING_ITEM].amount.value = prices.CA.shipping;
                details.items[TOTAL_ITEM].amount.value = prices.CA.total;
                details.shippingOptions = [{
                  "id": "discount",
                  "label": "Discount California shipping",
                  "amount": {"currencyCode": "USD", "value": prices.CA.shipping}
                }];
              } else {
                details.items[SHIPPING_ITEM].amount.value = prices.US.shipping;
                details.items[TOTAL_ITEM].amount.value = prices.US.total;
                details.shippingOptions = [{
                  "id": "standard",
                  "label": "Standard U.S.A. shipping",
                  "amount": {"currencyCode": "USD", "value": prices.US.shipping}
                }];
              }
            } else {
              details.items[SHIPPING_ITEM].amount.value = "0";
              details.items[TOTAL_ITEM].amount.value = total;
              delete details.shippingOptions;
            }
            info("resolve(details);");
            resolve(details);
          }));
        });

        request.addEventListener("shippingoptionchange", function(e) {
          error("shipping option should not change, as there's only one.");
        });

        info("request.show();");
        request.show().then(function(instrumentResponse) {
          // Process the instrumentResponse here.
          instrumentResponse.complete(true).then(function() {
            done("Thank you!",
                request.shippingAddress,
                request.shippingOption,
                instrumentResponse.methodName,
                instrumentResponse.details);
          }).catch(function(err) {
            // Unexpected errors.
            error("Uh oh, something bad happened: " + err.message);
          });
        }).catch(function(err) {
          // Typically no available payment instruments or error on instrument
          // side.
          error("Uh oh, something bad happened: " + err.message);
        });

      } catch(e) {
        error("Developer mistake that a user should never see: '" + e.message + "'");
      }
    }
  </script>
</body>
</html>
